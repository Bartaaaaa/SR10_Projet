<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/user.css">
</head>
<body>
    <%- include('barrenavigation') %> <!-- Inclure la barre de navigation -->

    <div class="content">
        <div class="header">
            <h2>
                <%= user.nom %> <%= user.prenom %> <span class="status">(<%= user.statut %>)</span> - <%= user.role %>
            </h2>
        </div>
        <div class="main-content">
            <div class="form-column">
                <form id="updateUserForm">
                    <div class="form-group">
                        <label for="nom">Nom</label>
                        <input type="text" id="nom" name="nom" required placeholder="Entrez votre Nom" value="<%= user.nom %>">    
                    </div>
                    <div class="form-group">
                        <label for="prenom">Prénom</label>
                        <input type="text" id="prenom" name="prenom" required placeholder="Entrez votre Prénom" value="<%= user.prenom %>">
                    </div>
                    <div class="form-group">
                        <label for="mail">Mail</label>
                        <input type="email" id="mail" name="mail" required placeholder="Entrez votre mail" value="<%= user.mail %>">
                    </div>
                    <div class="form-group">
                        <label for="tel">Téléphone</label>
                        <input type="tel" id="tel" name="tel" required placeholder="Entrez votre Telephone" value="<%= user.tel %>">
                    </div> 

                    <input type="text" id="role" name="role" hidden value="<%= user.role %>">

                    <div class="buttons">
                        <button class="btn-secondary" type="submit">Sauvegarder les modifications</button>
                    </div>
                </form>
            </div>



            <div class="right-column">
                <div class="info-part">

                    <% if (user.role === 'recruteur' || user.role === 'administrateur' ) { %>
                    <div class="info"> 
                        <b> Recruteur chez : </b> 
                    </div>
                    <div class="little_blue_card" id="orgaId">
                        <%= user.orga %>
                    </div>
                    <% } %>

                </div>
                <div class="buttons-part">

                    <% if (isPagePerso && user.role === 'recruteur') { %>
                        <button type="button" class="btn-primary" onclick="window.location.href = 'http://localhost:3000/candidature/mescandidatures'">Visualiser mes candidatures</button>
                        <button type="button" class="btn-primary" onclick="window.location.href = `http://localhost:3000/DemandeAdherRecruteur/adherenceslist/<%= organisation.siren %>`;">Visualiser mes demandes d'adhérences</button>
                        <button id="fichePoste" type="button" class="btn-primary" onclick="createNewFiche()">Créer une nouvelle fiche de Poste</button>

                        <% } %>
                    
                        <script>
                            function createNewFiche() {
                                // Retrieve the organization ID from the element
                                var orgaIdElement = document.getElementById('orgaId');
                                var orgaIdText = orgaIdElement ? orgaIdElement.textContent.trim() : '';
                                // Extract only the digits from the organization ID
                                var orgaIdDigits = orgaIdText.match(/\d+/g).join('');
                                // Redirect to the new page with the organization ID digits as a query parameter
                                window.location.href = 'http://localhost:3000/fichesPoste/detailsCreationFiche?orgaId=' + encodeURIComponent(orgaIdDigits);
                                // Redirect to the new page with the organization ID as a query parameter
                            }
                        </script>
                    <!-- Vérifier le rôle ici par rapport à l'utilisateur connecté et non pas le profil affiché -->

                    <% if (isPagePerso && user.role === 'candidat') { %>
                        <button type="button" class="btn-primary" id="change-role">Devenir recruteur</button>
                    <% } %>

                    <% if (!isPagePerso && user.role !== 'administrateur') { %>
                        <button type="button" class="btn-primary" id="make-admin">Rendre Administrateur</button>
                        <button type="button" class="btn-danger" id="supprimer">Supprimer</button>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
    <div class="return-button">
        <% if (isPagePerso) { %>
            <form action="/pageperso/deconnexion">
                <button type="submit">Déconnexion</button>
            </form>
        <% } else { %>
            <button type="button" onclick="window.history.go(-1);">Revenir à la page précédente</button>
        <% } %>
    </div>

    <script>

        function sendDataToServer(endPoint, formData, errorMessage, callback = null) {
            fetch(endPoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw data.error;
                }
                alert(data.message);
            })
            .catch((error) => {
                alert(errorMessage + error);
            })
            .finally(() => {
                if (callback) {
                    callback();
                }
            });
        }

        document.getElementById('updateUserForm').addEventListener('submit', function(event) {
            // Évite que le formulaire soit envoyé automatiquement au chargement de la page
            event.preventDefault(); 
            const id = window.location.pathname.replace('/users/', '');

            const formData = {
                id: id,
                prenom: document.getElementById('prenom').value,
                nom: document.getElementById('nom').value,
                tel: document.getElementById('tel').value,
                mail: document.getElementById('mail').value
            };
            // Besoin de reload la page pour avoir un affichage à jour par rapport aux données côté serveur
            sendDataToServer('/users/updateUser', formData, "Erreur lors de la mise à jour de l'utilisateur : ", () => { window.location.reload(); });
        });

        const makeAdminButton = document.getElementById('make-admin');
        if (makeAdminButton) {
            makeAdminButton.addEventListener('click', () => changeRole('administrateur'));
        }

        const currentRole = document.getElementById('role').value;
        document.getElementById('change-role').addEventListener('click', () => changeRole(currentRole === "candidat" ? "recruteur" : "candidat"));

        function changeRole (newRole) {
            const id = window.location.pathname.replace('/users/', '');
            const formData = {
                userId: id, 
                newRole: newRole
            }

            // Besoin de reload la page pour avoir un affichage à jour par rapport aux données côté serveur
            sendDataToServer('/users/updateRole', formData, "Erreur lors de la mise à jour de l'utilisateur : " , () => { window.location.reload(); });
        }




        // (Manon) A modifier : je pense qu'il est mieux de passer l'utilisateur d'actif à inactif
        document.getElementById('supprimer').addEventListener('click', () => {
            if (confirm('ATTENTION : vous vous apprétez à supprimer cet utilisateur. Confirmer ?')) {
                
                const id = window.location.pathname.replace('/users/', '');
                const formData = {
                    id: id
                }

                sendDataToServer('/users/deleteuser', formData, "Erreur lors de la suppression de l'utilisateur : ", () => { window.location.href = 'http://localhost:3000'; });
            }
        });

    </script>
    
</body>
</html>

