<body>
    <%- include('barrenavigation') %> <!-- Inclure la barre de navigation -->
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/stylesheets/listes.css"> <!-- Correct CSS inclusion -->

    </head>
    <h1><%= title %></h1>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Etat</th>
                    <th>Date de validité</th>
                    <th>Indications</th>
                    <th>Nombre de pièces</th>
                    <th>Fiche de poste associée</th>
                </tr>
            </thead>
            <tbody>
                <% OffresEmploi.forEach((offre) => { %>
                <tr>
                    <td class="offre-id"><%= offre.id %></td>
                    <td><%= offre.etatOffre %></td>
                    <td><%= offre.dateValidite %></td>
                    <td><%= offre.indication %></td>
                    <td><%= offre.nbPieces %></td>
                    <td><%= offre.fichePoste %></td>
                </tr>
                <% }) %>
            </tbody>
        </table>
    </div>
    <form id="candidatureForm" enctype="multipart/form-data">
        <label for="candidatureId">Saisissez l'id de l'offre à laquelle vous voulez candidater</label>
        <input required type="text" id="candidatureId">
        <label for="fileUpload">Ajouter des pièces jointes :</label>
        <input type="file" id="fileUpload" name="fileUpload" multiple>
        <button type="submit" class="btn btn-primary">Soumettre</button>
      </form>

<script> 
 

 document.getElementById('candidatureForm').addEventListener('submit', function(event) {
  event.preventDefault();

  const submitButton = event.target.querySelector('button[type="submit"]');
  submitButton.disabled = true;

  const offreIdInput = document.getElementById('candidatureId').value;
  const offreIds = Array.from(document.querySelectorAll('.offre-id')).map(td => td.textContent);

  if (!offreIds.includes(offreIdInput)) {
    alert('L\'ID de l\'offre saisi n\'est pas valide. Veuillez saisir un ID valide.');
    submitButton.disabled = false;
    return;
  }

  const form = document.getElementById('candidatureForm');
  const formData = new FormData(form);
  formData.append('offreEmploi', offreIdInput);
  formData.append('date', new Date().toISOString().split('T')[0]);
  formData.append('etat', 'attente');

  fetch('/offresemploi/addCandidature', {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (response.redirected) {
      window.location.href = response.url;
    } else if (!response.ok) {
      return response.json().then(errorData => {
        throw new Error(errorData.error || 'Erreur lors de l\'enregistrement de la candidature');
      });
    } else {
      return response.json();
    }
  })
  .then(data => {
    alert(data.message || 'Candidature enregistrée avec succès!');
    window.location.href = '/offresemploi/offresemploilist';
  })
  .catch(error => {
    console.error('Error:', error);
    alert(error.message || 'Erreur lors de l\'enregistrement de la candidature');
  })
  .finally(() => {
    submitButton.disabled = false;
  });
});



     

   



</script>

    <style>
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        form {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        form input[type="text"],
        form input[type="file"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        form button {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        form button:hover {
            background-color: #0056b3;
        }
    </style>
</body>
